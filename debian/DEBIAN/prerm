#!/bin/bash
#
# ROSE Link Pre-removal Script
# Safely stops services before package removal
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

info() {
    echo -e "${CYAN}→${NC} $1"
}

success() {
    echo -e "${GREEN}✓${NC} $1"
}

warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

case "$1" in
    remove|deconfigure)
        echo ""
        echo -e "${YELLOW}╔════════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${YELLOW}║              ROSE Link Pre-removal                             ║${NC}"
        echo -e "${YELLOW}╚════════════════════════════════════════════════════════════════╝${NC}"
        echo ""
        # Stop ROSE Link services
        info "Stopping ROSE Link services..."

        if systemctl is-active --quiet rose-backend 2>/dev/null; then
            systemctl stop rose-backend 2>/dev/null || warning "Could not stop rose-backend"
            success "Stopped rose-backend"
        fi

        if systemctl is-active --quiet rose-watchdog 2>/dev/null; then
            systemctl stop rose-watchdog 2>/dev/null || warning "Could not stop rose-watchdog"
            success "Stopped rose-watchdog"
        fi

        # Stop VPN if running
        if systemctl is-active --quiet wg-quick@wg0 2>/dev/null; then
            info "Stopping VPN tunnel..."
            systemctl stop wg-quick@wg0 2>/dev/null || warning "Could not stop wg-quick@wg0"
            success "Stopped VPN tunnel"
        fi

        # Disable services
        info "Disabling services..."
        systemctl disable rose-backend 2>/dev/null || true
        systemctl disable rose-watchdog 2>/dev/null || true
        success "Services disabled"

        echo ""
        success "Pre-removal completed"
        echo ""
        ;;

    upgrade)
        # On upgrade, just stop services quietly
        systemctl stop rose-backend 2>/dev/null || true
        systemctl stop rose-watchdog 2>/dev/null || true
        ;;

    failed-upgrade)
        # Do nothing on failed upgrade
        ;;

    *)
        # Default: do nothing
        ;;
esac

exit 0
