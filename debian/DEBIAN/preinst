#!/bin/bash
#
# ROSE Link Pre-installation Script
# Validates system requirements before installation
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
MIN_RAM_MB=512
MIN_DISK_MB=300
# Version is injected by build-deb.sh from the VERSION file
VERSION="__VERSION__"
TAGLINE="Your Raspberry Pi, Your Private VPN"
REPO_URL="github.com/oussrh/ROSE-LINK"

info() {
    echo -e "${CYAN}→${NC} $1"
}

success() {
    echo -e "${GREEN}✓${NC} $1"
}

warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

error() {
    echo -e "${RED}✗${NC} $1"
}

print_section() {
    local title="$1"
    echo ""
    echo -e "${CYAN}━━━ ${title} ━━━${NC}"
}

show_banner() {
    echo -e "${GREEN}"
    cat << 'BANNER'

               ####
              #######
            ##### #####
          #####    #####
  ###########        ############
 ###############  ###############
 ######      ########      ######
 #################     ##########    ############      ##########      ##########  ############
 ####   #######     ######   ####    ##############  ##############   ###########  ############
 ####    #################   ####    #####    ##### #####      #####  #####        ####
 ####    ###   #####  ####   ####    #####    ##### ####        ##### #########    ############
 ####    ###          ####   ####    #############  ####        #####    ########  ############
 ####    ###          ####   ####    ###########    #####      #####  ##     ##### ####
 ####    ###          ####   ####    #####   #####   ##############  ############# #############
  ####   ####         ####  #####    #####    #####    ##########     ##########   #############
    ####  #####     ##### #####
      ####  ##### ##### #####                    ####                 ####
        ###################          #####       ####                 ####
  ##            ###            ##    #####              ###   ##      ####    ###
 ########       ###       ########   #####       ####   ###########   #### ######
 ############   ###   ############   #####       ####   ############  #########
 ###      ####  ###  ####     ####   #####       ####   ####   #####  ########
 #####     #### #######      ####    #####       ####   ####   #####  #########
   #### ### ########## #########     ########### ####   ####   #####  #### #####
     #######  ####### ########       ########### ####   ####   #####  ####   #####
      ######################
            ###########
              ######
                ###
                ###
                ###
                ###
                ###

BANNER
    echo -e "${NC}"

    # Version and info line
    echo -e "  ${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "  ${GREEN}v${VERSION}${NC}  │  ${YELLOW}${TAGLINE}${NC}  │  ${CYAN}${REPO_URL}${NC}"
    echo -e "  ${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
}

check_system_requirements() {
    local has_errors=false

    show_banner

    echo -e "${CYAN}┌──────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${CYAN}│              Pre-Installation Check                          │${NC}"
    echo -e "${CYAN}└──────────────────────────────────────────────────────────────┘${NC}"

    print_section "System Requirements"

    # Check Debian version
    info "Checking operating system..."
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        case "$VERSION_CODENAME" in
            bullseye|bookworm|trixie)
                success "OS: $PRETTY_NAME (supported)"
                ;;
            *)
                warning "OS: $PRETTY_NAME (untested, may work)"
                ;;
        esac
    else
        warning "Could not determine OS version"
    fi

    # Check architecture
    info "Checking architecture..."
    local arch
    arch=$(uname -m)
    case "$arch" in
        armv7l|aarch64|arm64)
            success "Architecture: $arch (Raspberry Pi compatible)"
            ;;
        x86_64|i686)
            warning "Architecture: $arch (x86 - may work for testing)"
            ;;
        *)
            warning "Architecture: $arch (unknown compatibility)"
            ;;
    esac

    # Check RAM
    info "Checking system memory..."
    local ram_mb
    ram_mb=$(free -m | awk '/^Mem:/{print $2}')
    if [ "$ram_mb" -lt "$MIN_RAM_MB" ]; then
        error "Insufficient RAM: ${ram_mb}MB (minimum: ${MIN_RAM_MB}MB)"
        has_errors=true
    else
        success "RAM: ${ram_mb}MB (minimum: ${MIN_RAM_MB}MB)"
    fi

    # Check disk space
    info "Checking disk space..."
    local disk_mb
    disk_mb=$(df -m /opt 2>/dev/null | tail -1 | awk '{print $4}' || df -m / | tail -1 | awk '{print $4}')
    if [ "$disk_mb" -lt "$MIN_DISK_MB" ]; then
        error "Insufficient disk space: ${disk_mb}MB (minimum: ${MIN_DISK_MB}MB)"
        has_errors=true
    else
        success "Disk space: ${disk_mb}MB free (minimum: ${MIN_DISK_MB}MB)"
    fi

    # Check for WiFi interface
    info "Checking WiFi hardware..."
    local wifi_found=false
    for iface in /sys/class/net/*/wireless; do
        if [ -d "$iface" ]; then
            wifi_found=true
            local iface_name
            iface_name=$(echo "$iface" | cut -d/ -f5)
            success "WiFi interface found: $iface_name"
            break
        fi
    done
    if [ "$wifi_found" = false ]; then
        warning "No WiFi interface detected (may be blocked by rfkill)"
        warning "  Try: sudo rfkill unblock wifi"
    fi

    # Check Python version
    info "Checking Python version..."
    if command -v python3 &>/dev/null; then
        local python_version
        python_version=$(python3 --version 2>&1 | cut -d' ' -f2)
        local python_major
        python_major=$(echo "$python_version" | cut -d. -f1)
        local python_minor
        python_minor=$(echo "$python_version" | cut -d. -f2)

        if [ "$python_major" -ge 3 ] && [ "$python_minor" -ge 9 ]; then
            success "Python: $python_version (3.9+ required)"
        else
            error "Python version $python_version is too old (3.9+ required)"
            has_errors=true
        fi
    else
        info "Python3 will be installed as a dependency"
    fi

    print_section "Installation Status"

    # Check for existing installation
    info "Checking for existing installation..."
    if [ -d "/opt/rose-link" ]; then
        warning "Existing installation found - will be upgraded"
    else
        success "Clean installation"
    fi

    # Check for conflicting services
    info "Checking for service conflicts..."
    local conflicts=()

    if systemctl is-active --quiet hostapd 2>/dev/null; then
        conflicts+=("hostapd is running")
    fi

    if systemctl is-active --quiet dnsmasq 2>/dev/null; then
        conflicts+=("dnsmasq is running")
    fi

    if [ ${#conflicts[@]} -gt 0 ]; then
        warning "Running services that will be reconfigured:"
        for conflict in "${conflicts[@]}"; do
            warning "  - $conflict"
        done
    else
        success "No conflicting services"
    fi

    echo ""

    if [ "$has_errors" = true ]; then
        echo -e "${RED}┌──────────────────────────────────────────────────────────────┐${NC}"
        echo -e "${RED}│  ✗ Pre-installation check failed                             │${NC}"
        echo -e "${RED}│  Please resolve the issues above before installing           │${NC}"
        echo -e "${RED}└──────────────────────────────────────────────────────────────┘${NC}"
        return 1
    else
        echo -e "${GREEN}┌──────────────────────────────────────────────────────────────┐${NC}"
        echo -e "${GREEN}│  ✓ All checks passed - Proceeding with installation          │${NC}"
        echo -e "${GREEN}└──────────────────────────────────────────────────────────────┘${NC}"
        return 0
    fi
}

case "$1" in
    install|upgrade)
        check_system_requirements
        ;;
    abort-upgrade)
        # Nothing to do
        ;;
    *)
        # Default: do nothing
        ;;
esac

exit 0
