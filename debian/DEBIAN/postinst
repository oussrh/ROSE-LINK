#!/bin/bash
#
# ROSE Link Post-installation Script
# Configures the system after package installation
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
USER="rose"
GROUP="rose"
INSTALL_DIR="/opt/rose-link"
LOG_FILE="/var/log/rose-link-postinst.log"
DEFAULT_SSID="ROSE-Link"

# Generate a secure random password (12 chars, alphanumeric)
generate_password() {
    # Use /dev/urandom for secure randomness
    tr -dc 'A-Za-z0-9' < /dev/urandom | head -c 12
}

# Logging function
log() {
    local level="$1"
    shift
    local message="$*"
    local timestamp
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [$level] $message" >> "$LOG_FILE"
}

info() {
    echo -e "${CYAN}→${NC} $1"
    log "INFO" "$1"
}

success() {
    echo -e "${GREEN}✓${NC} $1"
    log "INFO" "$1"
}

warning() {
    echo -e "${YELLOW}⚠${NC} $1"
    log "WARN" "$1"
}

error() {
    echo -e "${RED}✗${NC} $1"
    log "ERROR" "$1"
}

print_header() {
    local title="$1"
    local color="${2:-$CYAN}"
    echo ""
    echo -e "${color}┌──────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${color}│  ${title}$(printf '%*s' $((58 - ${#title})) '')│${NC}"
    echo -e "${color}└──────────────────────────────────────────────────────────────┘${NC}"
    echo ""
}

print_section() {
    local title="$1"
    echo ""
    echo -e "${CYAN}━━━ ${title} ━━━${NC}"
}

# Initialize log
mkdir -p "$(dirname "$LOG_FILE")"
echo "=== ROSE Link Post-installation $(date) ===" >> "$LOG_FILE"

print_header "ROSE Link - Configuration" "$GREEN"

case "$1" in
    configure)
        # Create system user
        info "Creating system user '$USER'..."
        if ! id -u "$USER" &>/dev/null; then
            useradd -r -s /usr/sbin/nologin -d "$INSTALL_DIR" -c "ROSE Link Service Account" "$USER" || {
                error "Failed to create user '$USER'"
                exit 1
            }
            success "User '$USER' created"
        else
            success "User '$USER' already exists"
        fi

        # Create directories
        info "Creating directories..."
        # VPN directories
        mkdir -p /etc/wireguard/profiles
        mkdir -p /etc/openvpn/client
        # Other system directories
        mkdir -p /etc/nginx/ssl
        mkdir -p /var/log/rose-link
        mkdir -p /var/run/openvpn
        mkdir -p /var/lib/misc
        mkdir -p "$INSTALL_DIR/data"
        mkdir -p "$INSTALL_DIR/system"

        # VPN directories owned by rose for profile management
        chown -R "$USER:$GROUP" /etc/wireguard
        chown -R "$USER:$GROUP" /etc/openvpn/client
        chown "$USER:$GROUP" /var/run/openvpn
        chmod 700 /etc/wireguard
        chmod 700 /etc/wireguard/profiles
        chmod 700 /etc/openvpn/client
        chmod 755 /var/run/openvpn
        success "Directories created"

        # Set permissions
        info "Setting file permissions..."
        chown -R "$USER:$GROUP" "$INSTALL_DIR"
        chown -R "$USER:$GROUP" /var/log/rose-link
        # Secure data directory (contains API keys, configs)
        chmod 700 "$INSTALL_DIR/data"
        chmod 700 "$INSTALL_DIR/system"
        chmod +x "$INSTALL_DIR/system/rose-watchdog.sh" 2>/dev/null || true
        success "Permissions configured"

        # Setup Python virtual environment
        info "Setting up Python virtual environment..."
        if [ ! -d "$INSTALL_DIR/venv" ] || [ ! -x "$INSTALL_DIR/venv/bin/python" ]; then
            rm -rf "$INSTALL_DIR/venv" 2>/dev/null || true
            python3 -m venv "$INSTALL_DIR/venv" || {
                error "Failed to create Python virtual environment"
                exit 1
            }
            success "Python virtual environment created"
        else
            success "Python virtual environment already exists"
        fi

        # Always install/update Python dependencies
        info "Installing Python dependencies..."
        "$INSTALL_DIR/venv/bin/pip" install --upgrade pip -q
        if [ -f "$INSTALL_DIR/backend/requirements.txt" ]; then
            "$INSTALL_DIR/venv/bin/pip" install -r "$INSTALL_DIR/backend/requirements.txt" -q || {
                error "Failed to install Python dependencies"
                exit 1
            }
            success "Python dependencies installed"
        else
            warning "requirements.txt not found - skipping dependencies"
        fi
        chown -R "$USER:$GROUP" "$INSTALL_DIR/venv"

        # Detect WiFi interfaces and Raspberry Pi model
        WIFI_INTERFACES=()
        for iface in $(ls /sys/class/net/ 2>/dev/null); do
            if [ -d "/sys/class/net/$iface/wireless" ]; then
                WIFI_INTERFACES+=("$iface")
            fi
        done

        # Detect Pi model
        PI_MODEL=$(cat /proc/device-tree/model 2>/dev/null | tr -d '\0' || echo "Unknown")
        info "Detected: $PI_MODEL"

        # Detect if Pi supports 5GHz (Pi 4, Pi 5, Pi 400)
        SUPPORTS_5GHZ=false
        case "$PI_MODEL" in
            *"Pi 4"*|*"Pi 5"*|*"Pi 400"*)
                SUPPORTS_5GHZ=true
                ;;
        esac

        # Determine AP interface based on available interfaces
        if [ ${#WIFI_INTERFACES[@]} -ge 2 ]; then
            # Pi 4/5 or Pi with USB WiFi adapter - use secondary interface for AP
            WIFI_AP_INTERFACE="${WIFI_INTERFACES[1]}"
            WIFI_CLIENT_INTERFACE="${WIFI_INTERFACES[0]}"
            info "Dual WiFi mode: Client on $WIFI_CLIENT_INTERFACE, AP on $WIFI_AP_INTERFACE"
        elif [ ${#WIFI_INTERFACES[@]} -eq 1 ]; then
            # Single WiFi interface (Pi 3, Zero 2W) - must use ethernet for WAN
            WIFI_AP_INTERFACE="${WIFI_INTERFACES[0]}"
            WIFI_CLIENT_INTERFACE=""
            warning "Single WiFi interface detected ($WIFI_AP_INTERFACE)"
            warning "Ethernet connection required for internet access"
            echo ""
            echo -e "${YELLOW}╔════════════════════════════════════════════════════════════════╗${NC}"
            echo -e "${YELLOW}║  IMPORTANT: Single WiFi Interface Detected                    ║${NC}"
            echo -e "${YELLOW}╠════════════════════════════════════════════════════════════════╣${NC}"
            echo -e "${YELLOW}║  Your Raspberry Pi has only one WiFi interface.               ║${NC}"
            echo -e "${YELLOW}║  You MUST connect via Ethernet cable for internet access.     ║${NC}"
            echo -e "${YELLOW}║  The WiFi will be used exclusively for the hotspot.           ║${NC}"
            echo -e "${YELLOW}╚════════════════════════════════════════════════════════════════╝${NC}"
            echo ""
        else
            WIFI_AP_INTERFACE="wlan0"
            warning "No WiFi interface detected, defaulting to wlan0"
        fi
        info "Using WiFi AP interface: $WIFI_AP_INTERFACE"
        if [ "$SUPPORTS_5GHZ" = true ]; then
            info "5GHz WiFi supported - will configure for optimal performance"
        fi

        # Configure hostapd
        info "Configuring WiFi hotspot..."
        GENERATED_NEW_PASSWORD=false
        if [ -f "$INSTALL_DIR/system/hostapd.conf" ]; then
            # Check for existing configuration
            if [ -f /etc/hostapd/hostapd.conf ]; then
                # Preserve user's SSID and password if they exist (POSIX-compatible grep)
                EXISTING_SSID=$(grep '^ssid=' /etc/hostapd/hostapd.conf 2>/dev/null | cut -d= -f2 || echo "")
                EXISTING_PASS=$(grep '^wpa_passphrase=' /etc/hostapd/hostapd.conf 2>/dev/null | cut -d= -f2 || echo "")
            fi
            cp "$INSTALL_DIR/system/hostapd.conf" /etc/hostapd/hostapd.conf
            # Substitute interface placeholder
            sed -i "s/__WIFI_AP_INTERFACE__/${WIFI_AP_INTERFACE}/g" /etc/hostapd/hostapd.conf
            # Handle SSID and password
            if [ -n "$EXISTING_SSID" ] && [ "$EXISTING_SSID" != "$DEFAULT_SSID" ]; then
                # Restore user's custom SSID
                sed -i "s/^ssid=.*/ssid=${EXISTING_SSID}/" /etc/hostapd/hostapd.conf
            fi
            if [ -n "$EXISTING_PASS" ]; then
                # Restore existing password (user already has one)
                sed -i "s/__WIFI_PASSWORD__/${EXISTING_PASS}/" /etc/hostapd/hostapd.conf
            else
                # Fresh install: generate a random secure password
                WIFI_PASSWORD=$(generate_password)
                sed -i "s/__WIFI_PASSWORD__/${WIFI_PASSWORD}/" /etc/hostapd/hostapd.conf
                GENERATED_NEW_PASSWORD=true
            fi
            # Configure 5GHz for Pi 4/5 (better performance, less interference)
            if [ "$SUPPORTS_5GHZ" = true ]; then
                sed -i 's/^hw_mode=g/hw_mode=a/' /etc/hostapd/hostapd.conf
                sed -i 's/^channel=6/channel=36/' /etc/hostapd/hostapd.conf
                # Add 802.11ac support for Pi 4/5
                if ! grep -q "^ieee80211ac=" /etc/hostapd/hostapd.conf; then
                    echo "ieee80211ac=1" >> /etc/hostapd/hostapd.conf
                fi
                info "Configured 5GHz mode (channel 36) for better performance"
            fi
        else
            # Fallback: generate config inline
            if [ "$SUPPORTS_5GHZ" = true ]; then
                HW_MODE="a"
                CHANNEL="36"
                AC_SUPPORT="ieee80211ac=1"
            else
                HW_MODE="g"
                CHANNEL="6"
                AC_SUPPORT=""
            fi
            # Generate random password for fresh install
            WIFI_PASSWORD=$(generate_password)
            GENERATED_NEW_PASSWORD=true
            cat > /etc/hostapd/hostapd.conf << EOF
# ROSE Link Hotspot Configuration
interface=${WIFI_AP_INTERFACE}
driver=nl80211
ssid=${DEFAULT_SSID}
hw_mode=${HW_MODE}
channel=${CHANNEL}
country_code=BE
ieee80211n=1
${AC_SUPPORT}
wmm_enabled=1
auth_algs=1
wpa=2
wpa_passphrase=${WIFI_PASSWORD}
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP
EOF
        fi
        # Allow rose user to read/write hostapd config (for web UI configuration)
        chown rose:rose /etc/hostapd/hostapd.conf
        chmod 600 /etc/hostapd/hostapd.conf
        success "Hostapd configured"

        # Enable hostapd config
        if [ -f /etc/default/hostapd ]; then
            sed -i 's|#DAEMON_CONF=""|DAEMON_CONF="/etc/hostapd/hostapd.conf"|' /etc/default/hostapd 2>/dev/null || true
            sed -i 's|DAEMON_CONF=".*"|DAEMON_CONF="/etc/hostapd/hostapd.conf"|' /etc/default/hostapd 2>/dev/null || true
        fi

        # Configure dnsmasq
        info "Configuring DHCP/DNS server..."
        if [ ! -f /etc/dnsmasq.conf.rose-backup ] && [ -f /etc/dnsmasq.conf ]; then
            mv /etc/dnsmasq.conf /etc/dnsmasq.conf.rose-backup 2>/dev/null || true
        fi

        if [ -f "$INSTALL_DIR/system/dnsmasq.conf" ]; then
            cp "$INSTALL_DIR/system/dnsmasq.conf" /etc/dnsmasq.conf
            # Substitute interface placeholder
            sed -i "s/__WIFI_AP_INTERFACE__/${WIFI_AP_INTERFACE}/g" /etc/dnsmasq.conf
        else
            cat > /etc/dnsmasq.conf << EOF
# ROSE Link DHCP/DNS Configuration
interface=${WIFI_AP_INTERFACE}
bind-interfaces
dhcp-range=192.168.50.10,192.168.50.250,255.255.255.0,24h
dhcp-option=option:router,192.168.50.1
dhcp-option=option:dns-server,192.168.50.1,1.1.1.1
server=1.1.1.1
server=8.8.8.8
domain=roselink.local
local=/roselink.local/
cache-size=1000
EOF
        fi
        # Allow rose user to read dnsmasq leases for client listing
        if [ -f /var/lib/misc/dnsmasq.leases ]; then
            chown root:rose /var/lib/misc/dnsmasq.leases
            chmod 640 /var/lib/misc/dnsmasq.leases
        fi
        # Create leases file if it doesn't exist
        touch /var/lib/misc/dnsmasq.leases 2>/dev/null || true
        chown root:rose /var/lib/misc/dnsmasq.leases 2>/dev/null || true
        chmod 640 /var/lib/misc/dnsmasq.leases 2>/dev/null || true

        # Configure system to use local DNS (dnsmasq or AdGuard)
        # This ensures WireGuard can resolve hostnames before connecting
        mkdir -p /etc/resolvconf/resolv.conf.d
        echo "nameserver 127.0.0.1" > /etc/resolvconf/resolv.conf.d/head
        resolvconf -u 2>/dev/null || true
        success "dnsmasq configured"

        # Configure static IP for AP interface
        info "Configuring static IP..."
        if [ -f /etc/dhcpcd.conf ]; then
            # Using dhcpcd (Raspberry Pi OS, older Debian)
            # Remove any existing ROSE Link config first (handles interface changes)
            if grep -q "# ROSE Link AP Configuration" /etc/dhcpcd.conf 2>/dev/null; then
                sed -i '/# ROSE Link AP Configuration/,/^$/d' /etc/dhcpcd.conf 2>/dev/null || true
            fi
            # Add new configuration
            cat >> /etc/dhcpcd.conf << EOF

# ROSE Link AP Configuration
interface ${WIFI_AP_INTERFACE}
    static ip_address=192.168.50.1/24
    nohook wpa_supplicant
EOF
            success "Static IP configured (dhcpcd)"
        elif command -v nmcli &>/dev/null; then
            # Using NetworkManager (Debian 12+, Ubuntu)
            # Create a connection for the AP interface
            nmcli con delete "ROSE-AP" 2>/dev/null || true
            nmcli con add type wifi ifname "${WIFI_AP_INTERFACE}" con-name "ROSE-AP" \
                autoconnect no ssid "ROSE-Link" 2>/dev/null || true
            nmcli con mod "ROSE-AP" ipv4.addresses 192.168.50.1/24 ipv4.method manual 2>/dev/null || true
            success "Static IP configured (NetworkManager)"
        else
            warning "Could not configure static IP - no dhcpcd or NetworkManager found"
        fi

        # Install sudoers
        info "Configuring sudo permissions..."
        if [ -f "$INSTALL_DIR/system/rose-sudoers" ]; then
            cp "$INSTALL_DIR/system/rose-sudoers" /etc/sudoers.d/rose
        else
            cat > /etc/sudoers.d/rose << 'EOF'
# ROSE Link sudo rules
# Network management
rose ALL=(ALL) NOPASSWD: /usr/bin/nmcli *
rose ALL=(ALL) NOPASSWD: /usr/sbin/iw *
rose ALL=(ALL) NOPASSWD: /usr/bin/iw *
rose ALL=(ALL) NOPASSWD: /usr/sbin/ip *
rose ALL=(ALL) NOPASSWD: /usr/bin/ip *
rose ALL=(ALL) NOPASSWD: /usr/sbin/rfkill *
rose ALL=(ALL) NOPASSWD: /usr/bin/rfkill *

# WireGuard VPN
rose ALL=(ALL) NOPASSWD: /usr/bin/wg
rose ALL=(ALL) NOPASSWD: /usr/bin/wg show *
rose ALL=(ALL) NOPASSWD: /usr/bin/wg-quick up *
rose ALL=(ALL) NOPASSWD: /usr/bin/wg-quick down *

# Service management
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl start wg-quick@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop wg-quick@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart wg-quick@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl status wg-quick@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active wg-quick@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl start hostapd
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop hostapd
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart hostapd
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl reload hostapd
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl status hostapd
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active hostapd
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl start dnsmasq
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop dnsmasq
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart dnsmasq
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl status dnsmasq
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active dnsmasq
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl start nginx
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop nginx
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl reload nginx
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl status nginx
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active nginx
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl start rose-watchdog
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop rose-watchdog
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart rose-watchdog
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl status rose-watchdog
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active rose-watchdog
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl start AdGuardHome
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop AdGuardHome
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart AdGuardHome
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl status AdGuardHome
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active AdGuardHome
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl reboot
rose ALL=(ALL) NOPASSWD: /usr/sbin/reboot
rose ALL=(ALL) NOPASSWD: /usr/bin/journalctl *

# Firewall and QoS
rose ALL=(ALL) NOPASSWD: /usr/sbin/iptables *
rose ALL=(ALL) NOPASSWD: /usr/bin/iptables *
rose ALL=(ALL) NOPASSWD: /usr/sbin/iptables-save
rose ALL=(ALL) NOPASSWD: /usr/bin/iptables-save
rose ALL=(ALL) NOPASSWD: /usr/sbin/iptables-restore
rose ALL=(ALL) NOPASSWD: /usr/bin/iptables-restore
rose ALL=(ALL) NOPASSWD: /usr/sbin/tc *
rose ALL=(ALL) NOPASSWD: /usr/bin/tc *

# Hostapd client management
rose ALL=(ALL) NOPASSWD: /usr/sbin/hostapd_cli *
rose ALL=(ALL) NOPASSWD: /usr/bin/hostapd_cli *

# OpenVPN
rose ALL=(ALL) NOPASSWD: /usr/sbin/openvpn *
rose ALL=(ALL) NOPASSWD: /usr/bin/openvpn *
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl start openvpn@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop openvpn@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart openvpn@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl status openvpn@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active openvpn@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl start openvpn-client@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop openvpn-client@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart openvpn-client@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl status openvpn-client@*
rose ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active openvpn-client@*

# SSL certificate management
rose ALL=(ALL) NOPASSWD: /usr/bin/openssl *
rose ALL=(ALL) NOPASSWD: /usr/bin/certbot *
EOF
        fi
        chmod 440 /etc/sudoers.d/rose
        chown root:root /etc/sudoers.d/rose
        if visudo -c -f /etc/sudoers.d/rose >/dev/null 2>&1; then
            success "Sudo permissions configured"
        else
            warning "Sudo configuration may have issues"
            rm -f /etc/sudoers.d/rose
        fi

        # Generate SSL certificate
        info "Configuring SSL certificate..."
        if [ ! -f /etc/nginx/ssl/roselink.crt ]; then
            openssl req -x509 -nodes -days 3650 -newkey rsa:4096 \
                -keyout /etc/nginx/ssl/roselink.key \
                -out /etc/nginx/ssl/roselink.crt \
                -subj "/C=BE/ST=Local/L=Local/O=ROSE Link/OU=VPN/CN=roselink.local" \
                -addext "subjectAltName=DNS:roselink.local,DNS:localhost,IP:192.168.50.1,IP:127.0.0.1" \
                2>/dev/null || {
                    # Fallback for older OpenSSL without -addext
                    openssl req -x509 -nodes -days 3650 -newkey rsa:4096 \
                        -keyout /etc/nginx/ssl/roselink.key \
                        -out /etc/nginx/ssl/roselink.crt \
                        -subj "/C=BE/ST=Local/L=Local/O=ROSE Link/OU=VPN/CN=roselink.local" \
                        2>/dev/null
                }
            chmod 600 /etc/nginx/ssl/roselink.key
            chmod 644 /etc/nginx/ssl/roselink.crt
            success "SSL certificate generated"
        else
            success "SSL certificate already exists"
        fi

        # Configure Nginx
        info "Configuring web server..."
        if [ -f "$INSTALL_DIR/system/nginx/roselink" ]; then
            cp "$INSTALL_DIR/system/nginx/roselink" /etc/nginx/sites-available/roselink
        fi
        ln -sf /etc/nginx/sites-available/roselink /etc/nginx/sites-enabled/roselink 2>/dev/null || true
        rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
        if nginx -t >/dev/null 2>&1; then
            success "Nginx configured"
        else
            warning "Nginx configuration may have issues"
        fi

        # Enable IP forwarding
        info "Enabling IP forwarding..."
        echo "net.ipv4.ip_forward=1" > /etc/sysctl.d/99-rose-link.conf
        sysctl -w net.ipv4.ip_forward=1 >/dev/null 2>&1 || true
        success "IP forwarding enabled"

        # Configure iptables
        info "Configuring firewall rules..."
        iptables -t nat -F 2>/dev/null || true
        iptables -F FORWARD 2>/dev/null || true
        iptables -t nat -A POSTROUTING -o wg0 -j MASQUERADE
        iptables -A FORWARD -i "${WIFI_AP_INTERFACE}" -o wg0 -j ACCEPT
        iptables -A FORWARD -i wg0 -o "${WIFI_AP_INTERFACE}" -m state --state RELATED,ESTABLISHED -j ACCEPT
        iptables -A FORWARD -i "${WIFI_AP_INTERFACE}" ! -o wg0 -j REJECT --reject-with icmp-net-unreachable
        iptables -A FORWARD -i eth0 -o wg0 -j ACCEPT 2>/dev/null || true
        iptables -A FORWARD -i wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT
        iptables-save > /etc/iptables/rules.v4 2>/dev/null || true
        success "Firewall rules configured"

        # Install systemd services
        info "Installing systemd services..."
        if [ -f "$INSTALL_DIR/system/rose-backend.service" ]; then
            cp "$INSTALL_DIR/system/rose-backend.service" /etc/systemd/system/
        fi
        if [ -f "$INSTALL_DIR/system/rose-watchdog.service" ]; then
            cp "$INSTALL_DIR/system/rose-watchdog.service" /etc/systemd/system/
        fi
        systemctl daemon-reload
        success "Systemd services installed"

        # Install rose-monitoring command
        info "Installing monitoring management command..."
        if [ -f "$INSTALL_DIR/system/rose-monitoring" ]; then
            cp "$INSTALL_DIR/system/rose-monitoring" /usr/local/bin/rose-monitoring
            chmod +x /usr/local/bin/rose-monitoring
            success "rose-monitoring command installed"
        fi

        # Create monitoring config directory
        info "Setting up monitoring configuration..."
        mkdir -p "$INSTALL_DIR/monitoring/prometheus"
        mkdir -p "$INSTALL_DIR/monitoring/grafana/dashboards"
        if [ -d "$INSTALL_DIR/system/monitoring" ]; then
            cp -r "$INSTALL_DIR/system/monitoring/"* "$INSTALL_DIR/monitoring/" 2>/dev/null || true
        fi
        chown -R "$USER:$GROUP" "$INSTALL_DIR/monitoring"
        success "Monitoring configuration ready"

        # Install AdGuard Home
        info "Installing AdGuard Home DNS ad blocker..."
        ADGUARD_DIR="/opt/AdGuardHome"
        ADGUARD_BINARY="$ADGUARD_DIR/AdGuardHome"

        if [ -f "$ADGUARD_BINARY" ]; then
            success "AdGuard Home already installed"
        else
            # Determine architecture
            case "$(uname -m)" in
                aarch64|arm64) ADGUARD_ARCH="arm64" ;;
                armv7l|armv6l) ADGUARD_ARCH="armv7" ;;
                x86_64) ADGUARD_ARCH="amd64" ;;
                *)
                    warning "Unsupported architecture for AdGuard Home: $(uname -m)"
                    ADGUARD_ARCH=""
                    ;;
            esac

            if [ -n "$ADGUARD_ARCH" ]; then
                info "Downloading AdGuard Home for $ADGUARD_ARCH..."
                mkdir -p "$ADGUARD_DIR"

                DOWNLOAD_URL="https://static.adguard.com/adguardhome/release/AdGuardHome_linux_${ADGUARD_ARCH}.tar.gz"
                TEMP_FILE="/tmp/adguardhome.tar.gz"

                if curl -fsSL "$DOWNLOAD_URL" -o "$TEMP_FILE" 2>/dev/null; then
                    info "Extracting AdGuard Home..."
                    tar -xzf "$TEMP_FILE" -C /opt/
                    rm -f "$TEMP_FILE"

                    # Create initial configuration
                    info "Configuring AdGuard Home..."
                    cat > "$ADGUARD_DIR/AdGuardHome.yaml" << 'ADGUARD_EOF'
http:
  pprof:
    port: 6060
    enabled: false
  address: 0.0.0.0:3000
  session_ttl: 720h
users: []
auth_attempts: 5
block_auth_min: 15
http_proxy: ""
language: ""
theme: auto
dns:
  bind_hosts:
    - 0.0.0.0
  port: 53
  anonymize_client_ip: false
  ratelimit: 20
  ratelimit_subnet_len_ipv4: 24
  ratelimit_subnet_len_ipv6: 56
  ratelimit_whitelist: []
  refuse_any: true
  upstream_dns:
    - https://dns.cloudflare.com/dns-query
    - https://dns.google/dns-query
  upstream_mode: ""
  upstream_dns_file: ""
  bootstrap_dns:
    - 1.1.1.1
    - 8.8.8.8
  fallback_dns: []
  upstream_timeout: 10s
  all_servers: false
  fastest_addr: false
  fastest_timeout: 1s
  allowed_clients: []
  disallowed_clients: []
  blocked_hosts:
    - version.bind
    - id.server
    - hostname.bind
  trusted_proxies:
    - 127.0.0.0/8
    - ::1/128
  cache_size: 4194304
  cache_ttl_min: 0
  cache_ttl_max: 0
  cache_optimistic: false
  bogus_nxdomain: []
  aaaa_disabled: false
  enable_dnssec: true
  edns_client_subnet:
    custom_ip: ""
    enabled: false
    use_custom: false
  max_goroutines: 300
  handle_ddr: true
  ipset: []
  ipset_file: ""
  bootstrap_prefer_ipv6: false
  upstream_timeout: 10s
  private_networks: []
  use_private_ptr_resolvers: true
  local_ptr_upstreams: []
  use_dns64: false
  dns64_prefixes: []
  serve_http3: false
  use_http3_upstreams: false
  serve_plain_dns: true
tls:
  enabled: false
  server_name: ""
  force_https: false
  port_https: 443
  port_dns_over_tls: 853
  port_dns_over_quic: 853
  port_dnscrypt: 0
  dnscrypt_config_file: ""
  allow_unencrypted_doh: false
  certificate_chain: ""
  private_key: ""
  certificate_path: ""
  private_key_path: ""
  strict_sni_check: false
querylog:
  dir_path: ""
  ignored: []
  interval: 2160h
  size_memory: 1000
  enabled: true
  file_enabled: true
statistics:
  dir_path: ""
  ignored: []
  interval: 24h
  enabled: true
filters:
  - enabled: true
    url: https://adguardteam.github.io/HostlistsRegistry/assets/filter_1.txt
    name: AdGuard DNS filter
    id: 1
  - enabled: true
    url: https://adguardteam.github.io/HostlistsRegistry/assets/filter_2.txt
    name: AdAway Default Blocklist
    id: 2
whitelist_filters: []
user_rules: []
dhcp:
  enabled: false
  interface_name: ""
  local_domain_name: lan
  dhcpv4:
    gateway_ip: ""
    subnet_mask: ""
    range_start: ""
    range_end: ""
    lease_duration: 86400
    icmp_timeout_msec: 1000
    options: []
  dhcpv6:
    range_start: ""
    lease_duration: 86400
    ra_slaac_only: false
    ra_allow_slaac: false
filtering:
  blocking_ipv4: ""
  blocking_ipv6: ""
  blocked_services:
    schedule:
      time_zone: Local
    ids: []
  protection_disabled_until: null
  safe_search:
    enabled: false
    bing: true
    duckduckgo: true
    google: true
    pixabay: true
    yandex: true
    youtube: true
  blocking_mode: default
  parental_block_host: family-block.dns.adguard.com
  safebrowsing_block_host: standard-block.dns.adguard.com
  rewrites: []
  safebrowsing_cache_size: 1048576
  safesearch_cache_size: 1048576
  parental_cache_size: 1048576
  cache_time: 30
  filters_update_interval: 24
  blocked_response_ttl: 10
  filtering_enabled: true
  parental_enabled: false
  safebrowsing_enabled: false
  protection_enabled: true
clients:
  runtime_sources:
    whois: true
    arp: true
    rdns: true
    dhcp: true
    hosts: true
  persistent: []
log:
  file: ""
  max_backups: 0
  max_size: 100
  max_age: 3
  compress: false
  local_time: false
  verbose: false
os:
  group: ""
  user: ""
  rlimit_nofile: 0
schema_version: 28
ADGUARD_EOF

                    # Install as systemd service
                    info "Installing AdGuard Home service..."
                    "$ADGUARD_BINARY" -s install 2>/dev/null || true

                    # Enable service (will be started later)
                    systemctl enable AdGuardHome 2>/dev/null || true

                    # Configure dnsmasq to disable DNS (AdGuard handles it)
                    if [ -f /etc/dnsmasq.conf ]; then
                        if ! grep -q "# AdGuard Home handles DNS" /etc/dnsmasq.conf; then
                            # Disable DNS in dnsmasq - AdGuard listens on port 53
                            echo "" >> /etc/dnsmasq.conf
                            echo "# AdGuard Home handles DNS - disable dnsmasq DNS" >> /etc/dnsmasq.conf
                            echo "port=0" >> /etc/dnsmasq.conf
                            # Comment out upstream servers (not needed when port=0)
                            sed -i 's/^server=1.1.1.1$/# server=1.1.1.1 # AdGuard Home handles DNS/' /etc/dnsmasq.conf
                            sed -i 's/^server=8.8.8.8$/# server=8.8.8.8 # AdGuard Home handles DNS/' /etc/dnsmasq.conf
                            sed -i 's/^server=9.9.9.9$/# server=9.9.9.9 # AdGuard Home handles DNS/' /etc/dnsmasq.conf
                        fi
                    fi

                    # Configure system to use AdGuard for DNS resolution
                    # This ensures WireGuard can resolve hostnames before connecting
                    mkdir -p /etc/resolvconf/resolv.conf.d
                    echo "nameserver 127.0.0.1" > /etc/resolvconf/resolv.conf.d/head
                    resolvconf -u 2>/dev/null || true

                    success "AdGuard Home installed"
                else
                    warning "Failed to download AdGuard Home - can be installed later with: sudo rose-adguard install"
                fi
            fi
        fi

        # Clean up WiFi client connections if Ethernet is connected (for single-WiFi devices)
        info "Preparing WiFi interface for AP mode..."
        if ip link show eth0 2>/dev/null | grep -q "state UP"; then
            info "Ethernet connected - cleaning up WiFi client connections"
            # Remove any WiFi client connections on AP interface
            wifi_conns=$(nmcli -t -f NAME,DEVICE connection show 2>/dev/null | grep ":${WIFI_AP_INTERFACE}$" | cut -d: -f1 || true)
            if [ -n "$wifi_conns" ]; then
                echo "$wifi_conns" | while read -r conn; do
                    [ -n "$conn" ] && nmcli connection delete "$conn" >/dev/null 2>&1 || true
                done
            fi
            nmcli device disconnect "$WIFI_AP_INTERFACE" >/dev/null 2>&1 || true
            ip addr flush dev "$WIFI_AP_INTERFACE" 2>/dev/null || true
            ip addr add 192.168.50.1/24 dev "$WIFI_AP_INTERFACE" 2>/dev/null || true
            success "WiFi interface prepared for AP mode"
        else
            warning "No Ethernet - WiFi client connections preserved for WAN"
        fi

        # Enable services
        info "Enabling services..."
        systemctl enable rose-backend >/dev/null 2>&1 || warning "Could not enable rose-backend"
        systemctl enable rose-watchdog >/dev/null 2>&1 || warning "Could not enable rose-watchdog"
        # Unmask hostapd if masked (Debian default)
        systemctl unmask hostapd >/dev/null 2>&1 || true
        systemctl enable hostapd >/dev/null 2>&1 || warning "Could not enable hostapd"
        systemctl enable dnsmasq >/dev/null 2>&1 || warning "Could not enable dnsmasq"
        systemctl enable nginx >/dev/null 2>&1 || warning "Could not enable nginx"
        success "Services enabled"

        # Start services
        info "Starting services..."
        systemctl restart dhcpcd >/dev/null 2>&1 || true
        sleep 2
        # Start AdGuard Home first (DNS needs to be ready before dnsmasq)
        if [ -f "$ADGUARD_BINARY" ]; then
            systemctl restart AdGuardHome >/dev/null 2>&1 || warning "Could not start AdGuard Home"
        fi
        systemctl restart dnsmasq >/dev/null 2>&1 || warning "Could not start dnsmasq"
        systemctl restart hostapd >/dev/null 2>&1 || warning "Could not start hostapd"
        systemctl restart nginx >/dev/null 2>&1 || warning "Could not start nginx"
        systemctl restart rose-backend >/dev/null 2>&1 || warning "Could not start rose-backend"
        success "Services started"

        # Get current SSID and password from config
        CURRENT_SSID=$(grep '^ssid=' /etc/hostapd/hostapd.conf 2>/dev/null | cut -d= -f2 || echo "$DEFAULT_SSID")
        CURRENT_PASS=$(grep '^wpa_passphrase=' /etc/hostapd/hostapd.conf 2>/dev/null | cut -d= -f2 || echo "")

        # Final summary
        echo ""
        echo -e "${GREEN}┌──────────────────────────────────────────────────────────────┐${NC}"
        echo -e "${GREEN}│              ✓ Installation Complete!                        │${NC}"
        echo -e "${GREEN}└──────────────────────────────────────────────────────────────┘${NC}"

        print_section "System Info"
        echo -e "  ${CYAN}Device:${NC}      $PI_MODEL"
        echo -e "  ${CYAN}WiFi Mode:${NC}   $([ "$SUPPORTS_5GHZ" = true ] && echo "5GHz (802.11ac)" || echo "2.4GHz (802.11n)")"
        echo -e "  ${CYAN}Interface:${NC}   $WIFI_AP_INTERFACE"

        print_section "Web Interface"
        echo -e "  ${GREEN}►${NC} https://roselink.local"
        echo -e "  ${GREEN}►${NC} https://192.168.50.1"

        print_section "WiFi Hotspot"
        if [ -n "$EXISTING_SSID" ] && [ "$EXISTING_SSID" != "$DEFAULT_SSID" ]; then
            echo -e "  ${CYAN}SSID:${NC}      $CURRENT_SSID ${YELLOW}(preserved)${NC}"
        else
            echo -e "  ${CYAN}SSID:${NC}      $CURRENT_SSID"
        fi
        if [ "$GENERATED_NEW_PASSWORD" = true ]; then
            echo -e "  ${CYAN}Password:${NC}  ${GREEN}${CURRENT_PASS}${NC}"
            echo ""
            echo -e "  ${YELLOW}┌────────────────────────────────────────────────────────┐${NC}"
            echo -e "  ${YELLOW}│  ⚠ SAVE THIS PASSWORD - Generated randomly for you    │${NC}"
            echo -e "  ${YELLOW}│  Change via web UI or /etc/hostapd/hostapd.conf        │${NC}"
            echo -e "  ${YELLOW}└────────────────────────────────────────────────────────┘${NC}"
        else
            echo -e "  ${CYAN}Password:${NC}  ${YELLOW}(preserved from previous install)${NC}"
        fi

        if [ -z "$WIFI_CLIENT_INTERFACE" ]; then
            echo ""
            echo -e "  ${RED}┌────────────────────────────────────────────────────────┐${NC}"
            echo -e "  ${RED}│  ⚠ ETHERNET REQUIRED - Single WiFi interface detected  │${NC}"
            echo -e "  ${RED}│  Connect Ethernet cable for internet access            │${NC}"
            echo -e "  ${RED}└────────────────────────────────────────────────────────┘${NC}"
        fi

        print_section "Monitoring (Optional)"
        echo -e "  ${GREEN}Enable:${NC}   sudo rose-monitoring enable"
        echo -e "  ${CYAN}Status:${NC}   rose-monitoring status"
        echo -e "  ${RED}Disable:${NC}  sudo rose-monitoring disable"

        echo ""
        echo -e "  ${YELLOW}ℹ Accept the self-signed certificate warning in your browser${NC}"
        echo ""
        ;;

    abort-upgrade|abort-remove|abort-deconfigure)
        info "Post-installation aborted"
        ;;

    *)
        error "Unknown argument: $1"
        exit 1
        ;;
esac

log "INFO" "Post-installation completed successfully"
exit 0
